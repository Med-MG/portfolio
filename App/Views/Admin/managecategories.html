{% extends "adminbase.html" %}
{% block icon %}pe-7s-graph{% endblock %}
{% block title %}Managing categoris{% endblock %}
{% block subtitle %} This section is for managing categories {% endblock %}
{% block innerbody %}
<div class="row justify-content-xl-center">
    <div class="col-md-8">
        <div class="main-card mb-2 card">
            <div class="card-body">
                <h5 class="card-title">General Info</h5>
                {% for proj in project %}
                <form method="POST" id="formEdit" enctype="multipart/form-data" class="needs-validation" novalidate="">
                    <input type="text" id="ActionType" hidden value="add">
                    <div class="form-row">
                        <div class="col-md-4 mb-3">
                            <label for="title">Category Title</label>
                            <input type="text" class="form-control" id="category" placeholder="category name" name="category" required="" />
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="location">Slug</label>
                            <input type="text" class="form-control" pattern="^[A-Za-z]+$" id="slug" placeholder="slug must be one word" name="location" required="" />
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>
                    <input class="btn btn-primary" id="submitCat" type="submit" name="submitCat">
                </form>
                
                <script>
                    // Example starter JavaScript for disabling form submissions if there are invalid fields
                    (function () {
                        "use strict";
                        window.addEventListener(
                            "load",
                            function () {
                                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                                var forms = document.getElementsByClassName("needs-validation");
                                // Loop over them and prevent submission
                                var validation = Array.prototype.filter.call(forms, function (
                                    form
                                ) {
                                    form.addEventListener(
                                        "submit",
                                        function (event) {
                                            if (form.checkValidity() === false) {
                                                event.preventDefault();
                                                event.stopPropagation();
                                            }
                                            form.classList.add("was-validated");
                                        },
                                        false
                                    );
                                });
                            },
                            false
                        );
                    })();
                </script>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="main-card mb-3 card">
            <div class="card-body"><h5 class="card-title">All categories</h5>
                <table class="mb-0 table table-striped">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>category Name</th>
                        <th>slug</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                        {% for cat in categories %}
                        <tr>
                            <th scope="row">{{cat.id}}</th>
                            <td>{{cat.cat_name}}</td>
                            <td>{{cat.slug}}</td>
                            <td class="text-center">
                                <a href="/Project/editCategory?id={{cat.id}}">
                                    <button type="button" id="PopoverCustomT-1"
                                        class=" btn-wide btn btn-success btn-icon-only">
                                        <i class="pe-7s-note" style="font-size: 1rem;"></i> Edit
                                    </button>
                                </a>
                                <button type="button" id="PopoverCustomT-1"
                                    class=" btn-icon btn-icon-only btn btn-outline-danger"
                                    value="/Project/deleteCategory?id={{cat.id}}" data-toggle="modal"
                                    data-target="#exampleModal">
                                    <i class="pe-7s-trash" style="font-size: 1rem;"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="/assets/js/uploadImages.js"></script>
<script>
    $(function () {

        /* Check File API compatibility */
        if (!$.fileReader()) {
            alert("File API is not supported on your browser");
        } else {
            console.log("File API is supported on your browser");
        }

        /* createImage Event */
        $(document).on("createImage", function (e) {
            console.log(e.file.name);
            console.log(e.file.size);
            console.log(e.file.type);
        });

        /* deleteImage Event */
        $(document).on("deleteImage", function (e) {
            console.log(e.file.name);
            console.log(e.file.size);
            console.log(e.file.type);
            /* if not there are images, the button is disabled */
            if ($("#upload-preview").countImages() == 0) {
                $("#btn").attr("disabled", "disabled");
            }
        });

        /* Prevent form submit */
        $("#form").on("submit", function (e) {
            e.preventDefault();
        });

        /* Preview and Validate */
        $("#form input[type='file']").on("change", function () {

            $("#upload-preview").uploadImagesPreview("#form", {
                image_type: "jpg|jpeg|png|gif",
                min_size: 24,
                max_size: (1024 * 1024 * 3),
                /* 3 Mb */
                max_files: 10
            }, function () {
                switch (__errors__upload__) /* Check the possibles erros */ {
                    case 'ERROR_CONTENT_TYPE':
                        alert("Error content type");
                        break;
                    case 'ERROR_MIN_SIZE':
                        alert("Error min size");
                        break;
                    case 'ERROR_MAX_SIZE':
                        alert("Error max size");
                        break;
                    case 'ERROR_MAX_FILES':
                        alert("Error max files");
                        break;
                    default:
                        $("#btn").removeAttr("disabled");
                        break; /* Activate the button Form */
                }
            });
        });

        /* Send form */
        $("#btn").on("click", function () {

            /*images are required */
            if ($("#upload-preview").countImages() > 0) {
                $("#upload-preview").uploadImagesAjax("/project/upload", {
                    params: {
                        idEdit: $("#idEdit").val(),
                    },
                    /* Set the extra parameters here */
                    beforeSend: function () {
                        console.log("Sending ...");
                    },
                    success: function (data) {
                        $("#toastr").html(data);
                    },
                    error: function (jqXHR, exception) {
                        var msg = '';
                        if (jqXHR.status === 0) {
                            msg = 'Not connect.\n Verify Network.';
                        } else if (jqXHR.status == 404) {
                            msg = 'Requested page not found. [404]';
                        } else if (jqXHR.status == 500) {
                            msg = 'Internal Server Error [500].';
                        } else if (exception === 'parsererror') {
                            msg = 'Requested JSON parse failed.';
                        } else if (exception === 'timeout') {
                            msg = 'Time out error.';
                        } else if (exception === 'abort') {
                            msg = 'Ajax request aborted.';
                        } else {
                            msg = 'Uncaught Error.\n' + jqXHR.responseText;
                        }
                        console.log(msg);
                        $('#upload-preview').html('Uncaught Error.\n' + jqXHR.responseText);
                    },
                    complete: function () {
                        console.log("Completed");
                    }
                });
            } else { // The button is not activated
                $(this).attr("disabled", "disabled");
            }
        });

        const delete_buttons = document.querySelectorAll('#PopoverCustomT-1');
        for(const el of delete_buttons ){
            el.addEventListener('click', (e) => {
            let link = e.currentTarget.value;
            let filename = e.currentTarget.parentNode.parentNode.children[0].children[0].value;
            console.log(filename);
            document.querySelector('.deletion_link').href = link;
            $("#deletionBTN").attr('value',filename);
            $("#exampleModal > div > div > div.modal-footer > a > button").attr('data-dismiss', 'modal');
            });
        }

        /* delete an image using ajax */
        $(".deletion_link").on("click", function(e){
            e.preventDefault();
            console.log('clicked');
            var imageId = $(this).attr('href');
            var imageName = $("#deletionBTN").attr('value');

            $.ajax({
                type: "POST",
                url: "/Project/deleteProjectImage",
                dataType: "json",
                data: {imageId:imageId, imageName:imageName},
                success: function(data){
                    if(data.code == "200"){
                        toastr.success(data.msg);
                    } else {
                        toastr.error(data.msg);
                    }

                }

            });
        })
        /* delete an image using ajax */
        $("#btnEdit").on("click", function(e){
            e.preventDefault();
            let params = {
                projectId: $("#project_id").val(),
                title: $("#title").val(),
                location: $("#location").val(),
                category: $("#category").val(),
                description: $("#description").val(),
                order_date: $("#order_date").val(),
                final_date: $("#final_date").val(),
                projectlink: $("#projectlink").val()
            }
            
            $.ajax({
                type: "POST",
                url: "/Project/updateProjectdata",
                dataType: "json",
                data: params,
                beforeSend: function(){console.log("Sending ...");},
				success: function(data){
                    if(data.code == "200"){
                        toastr.success(data.msg);
                    } else {
                        toastr.error(data.msg);
                    }
                },
                error: function (jqXHR, exception) {
                    var msg = '';
                    if (jqXHR.status === 0) {
                        msg = 'Not connect.\n Verify Network.';
                    } else if (jqXHR.status == 404) {
                        msg = 'Requested page not found. [404]';
                    } else if (jqXHR.status == 500) {
                        msg = 'Internal Server Error [500].';
                    } else if (exception === 'parsererror') {
                        msg = 'Requested JSON parse failed.';
                    } else if (exception === 'timeout') {
                        msg = 'Time out error.';
                    } else if (exception === 'abort') {
                        msg = 'Ajax request aborted.';
                    } else {
                        msg = 'Uncaught Error.\n' + jqXHR.responseText;
                    }
                    console.log(msg);

                },
				complete: function(){console.log("Completed");}


            });
        })
    });
</script>
{% endblock %}